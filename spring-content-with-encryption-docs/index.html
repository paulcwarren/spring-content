<!DOCTYPE html>
<html lang="en">
    <head>
      <script>
	// Hack for scrolling window when linking to anchor tag with fixed nav header
        var shiftWindow = function() { scrollBy(0, -75) };
        window.addEventListener("hashchange", shiftWindow);
        function load() { if (window.location.hash) shiftWindow(); }
      </script>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Encryption - Content Services for Spring</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/http.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="../js/base.js"></script> 
    </head>

    <body class="">

      <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
	<div class="container">
	<a class="navbar-brand" href="..">Content Services for Spring</a>
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse">
          <!-- Main navigation -->
          <nav class="nav">
            <ul class="navbar-nav">
              <li >
                <a class="nav-link" href="..">Home</a>
              </li>
              <li class="nav-item dropdown active">
                <a href="#" role="button" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="nav-dropdown-Guides">Guides <b class="caret"></b></a>
                <div class="dropdown-menu" aria-labelledby="nav-dropdown-Guides">
                  
<a href="../spring-content-fs-docs/" class="dropdown-item">Java API</a>
                  
<a href="../spring-content-rest-docs/" class="dropdown-item">REST API</a>
                  
<a href="../spring-content-with-renditions-docs/" class="dropdown-item">Renditions</a>
                  
<a href="../spring-content-with-fulltext-docs/" class="dropdown-item">Fulltext</a>
                  
<a href="../spring-content-with-versions-docs/" class="dropdown-item">Versions</a>
                  
<a href="../spring-content-with-rbac-docs/" class="dropdown-item">RBAC</a>
                  
<a href="../spring-content-with-cmis-docs/" class="dropdown-item">CMIS</a>
                  
<a href="./" class="dropdown-item active">Encryption</a>
                </div>
              </li>
            </ul>
          </nav>

          <ul class="navbar-nav flex-row ml-md-auto d-none d-md-flex">
            <li class="nav-item">
              <a class="nav-link" href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
		<i class="fa fa-search"></i> Search
              </a>
            </li>
          </ul>
	</div>
	</div>
      </nav><div id="content" class="container">
        
      <div class="row">
        <div class="col-md-9" role="main">


<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    
    
    <li class="breadcrumb-item">Guides</li>
    
    
    <li class="breadcrumb-item active" aria-current="page">Encryption</li>
  </ol>
</nav>


<h1 id="getting-started-spring-content-with-encryption">Getting Started Spring Content with Encryption</h1>
<h2 id="what-youll-build">What you'll build</h2>
<p>We'll build on the previous guide <a href="../spring-content-rest-docs/">Getting Started with Spring Content REST API</a>.</p>
<h2 id="what-youll-need">What you'll need</h2>
<ul>
<li>
<p>About 30 minutes</p>
</li>
<li>
<p>A favorite text editor or IDE</p>
</li>
<li>
<p>JDK 1.8 or later</p>
</li>
<li>
<p>Maven 3.0+</p>
</li>
<li>
<p>Docker Desktop (for the vault test container)</p>
</li>
</ul>
<h2 id="how-to-complete-this-guide">How to complete this guide</h2>
<p>Before we begin let's set up our development environment:</p>
<ul>
<li>
<p>Download and unzip the source repository for this guide, or clone it
using Git: <code>git clone https://github.com/paulcwarren/spring-content-gettingstarted.git</code></p>
</li>
<li>
<p>We are going to start where Getting Started with Spring Content REST API leaves off so
 <code>cd</code> into <code>spring-content-gettingstarted/spring-content-rest/complete</code></p>
</li>
</ul>
<p>When you're finished, you can check your results against the code in
<code>spring-content-gettingstarted/spring-content-with-encryption/complete</code>.</p>
<h2 id="update-dependencies">Update dependencies</h2>
<p>Add the <code>com.github.paulcwarren:spring-content-encryption</code> dependency.  This provides us the implementation of a EncryptingContentStore.</p>
<p>Also add <code>org.testcontainers:vault:1.17.6</code>.  We are going to use vault to provide a keyring for encrypting the content encryption key which in turn is used to encrypt the content. </p>
<p><code>pom.xml</code></p>
<pre><code class="java">
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
  	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
  
  	&lt;artifactId&gt;spring-content-with-encryption&lt;/artifactId&gt;

	&lt;parent&gt;
		&lt;groupId&gt;com.github.paulcwarren&lt;/groupId&gt;
		&lt;artifactId&gt;gettingstarted-spring-content&lt;/artifactId&gt;
		&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
		&lt;relativePath&gt;../../pom.xml&lt;/relativePath&gt;
	&lt;/parent&gt;

	&lt;dependencyManagement&gt;
		&lt;dependencies&gt;
			&lt;dependency&gt;
				&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
				&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
				&lt;version&gt;3.1.0&lt;/version&gt;
				&lt;type&gt;pom&lt;/type&gt;
				&lt;scope&gt;import&lt;/scope&gt;
			&lt;/dependency&gt;
		&lt;/dependencies&gt;
	&lt;/dependencyManagement&gt;

	&lt;dependencies&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.h2database&lt;/groupId&gt;
			&lt;artifactId&gt;h2&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
			&lt;artifactId&gt;spring-boot-starter-data-rest&lt;/artifactId&gt;
		&lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.github.paulcwarren&lt;/groupId&gt;
			&lt;artifactId&gt;spring-content-fs-boot-starter&lt;/artifactId&gt;
			&lt;version&gt;${spring.content.version}&lt;/version&gt;
		&lt;/dependency&gt;
 		&lt;dependency&gt;
			&lt;groupId&gt;com.github.paulcwarren&lt;/groupId&gt;
			&lt;artifactId&gt;spring-content-rest-boot-starter&lt;/artifactId&gt;
			&lt;version&gt;${spring.content.version}&lt;/version&gt;
		&lt;/dependency&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
          &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;/dependency&gt;
		&lt;dependency&gt;
			&lt;groupId&gt;com.github.paulcwarren&lt;/groupId&gt;
			&lt;artifactId&gt;spring-content-encryption&lt;/artifactId&gt;
			&lt;version&gt;${spring.content.version}&lt;/version&gt;
		&lt;/dependency&gt;
</code></pre>

<h2 id="vault-testcontainer">Vault TestContainer</h2>
<p>First we add a simple class that creates and starts a vault test container upon demand.  The vault is configured with a vault token <code>root-token</code> (referenced later) and enables the transit module that provides cryptographic functions to the encrypting content store. </p>
<p><code>src/main/java/gettingstarted/VaultContainerSupport.java</code></p>
<pre><code>
package gettingstarted;

import org.testcontainers.vault.VaultContainer;

public class VaultContainerSupport {

    private static VaultContainer vaultContainer = null;

    public static VaultContainer getVaultContainer() {

        if (vaultContainer == null) {
            vaultContainer = new VaultContainer&lt;&gt;()
                    .withVaultToken("root-token")
                    .withVaultPort(8200)
                    .withInitCommand("secrets enable transit");

            vaultContainer.start();
        }

        return vaultContainer;
    }
}
</code></pre>

<h2 id="configuration">Configuration</h2>
<p>Next we need to introduce a small <code>Configuration</code> class to provide a vault endpoint to our application as well as configuring our encrypting content store.  We add the following <code>@Configuration</code> to our <code>SpringContentApplication</code>.</p>
<p><code>src/main/java/gettingstarted/SpringContentApplication.java</code></p>
<pre><code>
package gettingstarted;

import internal.org.springframework.content.fragments.EncryptingContentStoreConfiguration;
import internal.org.springframework.content.fragments.EncryptingContentStoreConfigurer;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.content.encryption.EnvelopeEncryptionService;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.vault.authentication.ClientAuthentication;
import org.springframework.vault.authentication.TokenAuthentication;
import org.springframework.vault.client.VaultEndpoint;
import org.springframework.vault.config.AbstractVaultConfiguration;
import org.springframework.vault.core.VaultOperations;

@SpringBootApplication
public class SpringContentApplication {

	public static void main(String[] args) {
		SpringApplication.run(SpringContentApplication.class, args);
	}

	@Configuration
	public static class Config extends AbstractVaultConfiguration {

		@Override
		public VaultEndpoint vaultEndpoint() {

			String host = VaultContainerSupport.getVaultContainer().getHost();
			int port = VaultContainerSupport.getVaultContainer().getMappedPort(8200);

			VaultEndpoint vault = VaultEndpoint.create(host, port);
			vault.setScheme("http");
			return vault;
		}

		@Override
		public ClientAuthentication clientAuthentication() {
			return new TokenAuthentication("root-token");
		}

		@Bean
		public EnvelopeEncryptionService encrypter(VaultOperations vaultOperations) {
			return new EnvelopeEncryptionService(vaultOperations);
		}

		@Bean
		public EncryptingContentStoreConfigurer config() {
			return new EncryptingContentStoreConfigurer&lt;FileContentStore&gt;() {
				@Override
				public void configure(EncryptingContentStoreConfiguration config) {
					config.keyring("fsfile").encryptionKeyContentProperty("key");
				}
			};
		}
	}
}
</code></pre>

<p>Points to note:
- the <code>clientAuthentication</code> references the <code>root-token</code>
- the <code>encrypter</code> bean creates an instance an <code>EnvelopeEncryptionService</code>.  This is used by the <code>EncyptingContentStore</code> to provide <a href="https://docs.aws.amazon.com/wellarchitected/latest/financial-services-industry-lens/use-envelope-encryption-with-customer-master-keys.html">envelope encryption</a> on the content.
- the <code>config</code> bean configures the <code>EnryptingContentStore</code> specifying the vault keyring to use to encrypt the content encryption key and the content property attribute to use to store that encrypted key for later use when decrypting content.</p>
<h2 id="update-file">Update File</h2>
<p>Update File to add the new content property attribute called <code>key</code> that will store the encrypted content encryption key.</p>
<p><code>src/main/java/gettingstarted/File.java</code></p>
<pre><code>
package gettingstarted;

import java.util.Date;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;

import com.fasterxml.jackson.annotation.JsonIgnore;
import org.springframework.content.commons.annotations.ContentId;
import org.springframework.content.commons.annotations.ContentLength;
import org.springframework.content.commons.annotations.MimeType;

import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;

@Entity
@Getter
@Setter
@NoArgsConstructor
public class File {

	@Id
	@GeneratedValue(strategy = GenerationType.AUTO)
	private Long id;
	private String name;
	private Date created = new Date();
	private String summary;

	@ContentId private String contentId;
	@ContentLength private long contentLength;
	@MimeType private String contentMimeType = "text/plain";
	@JsonIgnore
	private byte[] contentKey;
}
</code></pre>

<h2 id="update-filecontentstore">Update FileContentStore</h2>
<p>Decorate the <code>FileContentStore</code> as an <code>EncryptingContentStore</code> to enable encryption/decryption on the content.</p>
<p><code>src/main/java/gettingstarted/FileContentStore.java</code></p>
<pre><code>
package gettingstarted;

import org.springframework.content.commons.repository.ContentStore;

import org.springframework.content.encryption.EncryptingContentStore;
import org.springframework.content.rest.StoreRestResource;

@StoreRestResource
public interface FileContentStore extends ContentStore&lt;File, String&gt;, EncryptingContentStore&lt;File, String&gt; {
}
</code></pre>

<h2 id="build-an-executable-jar">Build an executable JAR</h2>
<p>If you are using Maven, you can run the application using <code>mvn spring-boot:run</code>.
Or you can build the JAR file with <code>mvn clean package</code> and run the JAR
by typing:</p>
<p><code>java -jar target/gettingstarted-spring-content-with-encryption-0.0.1.jar</code></p>
<p>As the application starts up look for the root of the filesystem storage.  We'll look in here shortly to check content is encrypted.  Look for the 
log entry that starts <code>Default filesystem storage to ...</code> and copy the file path. e.g. </p>
<pre><code>2022-12-06 21:45:14.180  INFO 89223 --- [           main] o.s.c.fs.io.FileSystemResourceLoader     : Defaulting filesystem root to /var/folders/65/d8zxcwh13sjfrkry92vgs5x80000gr/T/13946690314057106966
</code></pre>

<h2 id="test-encryption">Test Encryption</h2>
<p>Create an entity:</p>
<p><code>$ curl -X POST -H 'Content-Type:application/hal+json' -d '{}' http://localhost:8080/files/</code></p>
<p>Associate content with that entity:</p>
<p><code>$ curl -X PUT -H 'Content-Type:text/plain' -d 'Hello Spring Content World!' http://localhost:8080/files/1/content</code></p>
<p>Get the content id:</p>
<pre><code>$ curl -X GET -H 'Accept:application/hal+json' http://localhost:8080/files/1
{
  &quot;name&quot; : null,
  &quot;created&quot; : &quot;2022-12-07T05:47:42.356+00:00&quot;,
  &quot;summary&quot; : null,
  &quot;contentId&quot; : &quot;2d654dfc-57dc-44b7-aad9-f9ad0701c5d1&quot;,
  &quot;contentLength&quot; : 27,
  &quot;contentMimeType&quot; : &quot;text/plain&quot;,
  &quot;_links&quot; : {
    &quot;self&quot; : {
      &quot;href&quot; : &quot;http://localhost:8080/files/1&quot;
    },
    &quot;file&quot; : {
      &quot;href&quot; : &quot;http://localhost:8080/files/1&quot;
    },
    &quot;content&quot; : {
      &quot;href&quot; : &quot;http://localhost:8080/files/1/content&quot;
    }
  }
}
</code></pre>

<p>Copy the <code>contentId</code></p>
<p>Check the content is encrypted:</p>
<p><code>$ cat /var/folders/65/d8zxcwh13sjfrkry92vgs5x80000gr/T/13946690314057106966/&lt;contnetId&gt;</code></p>
<p>i.e.</p>
<pre><code>$ cat /var/folders/65/d8zxcwh13sjfrkry92vgs5x80000gr/T/13946690314057106966/2d654dfc-57dc-44b7-aad9-f9ad0701c5d1
��H�}��l������إ�.��^
</code></pre>

<p>Fetch the content:</p>
<pre><code>$ curl -H 'Accept:text/plain' http://localhost:8080/files/1/content
Hello Spring Content World!
</code></pre>

<h2 id="summary">Summary</h2>
<p>Congratulations!  You've just written a simple application that uses Spring Content and Spring Content Encryption to be store content encrypted.</p>
<p>Spring Content Encryption is also capable of serving bytes ranges.  The default implementation uses AES CTR encryption and when used with Spring Content S3 will decrypt and serve just the byte ranges.  With any other storage the content will be fully decrypted before serving the byte range.</p>

<ul class="metadata page-metadata" data-bi-name="page info" lang="en-us" dir="ltr">
  <li class="last-updated-holder displayDate loading">
    <span class="last-updated-text">Last updated:</span>
    <time role="presentation" datetime="2018-10-25T00:00:00.000Z" data-article-date-source="ms.date"></time>
  </li>
<!--
  <li class="readingTime">
    2 minutes to read
  </li>
-->
  <li class="contributors-holder">
    <span class="contributors-text">Contributors</span>
    <ul class="contributors" data-bi-name="contributors"></ul>
  </li>
</ul>
</div>
        <div class="col-md-3"><div class="navbar-light navbar-expand-md hidden-print sticky-top sticky-offset" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    <div id="toc-collapse" class="navbar-collapse collapse card">
        <ul class="nav flex-column bs-sidenav">
            <li class="nav-item main"><a class="nav-link" href="#getting-started-spring-content-with-encryption">Getting Started Spring Content with Encryption</a></li>
                <li class="nav-item">
                    <a href="#what-youll-build" class="nav-link">What you'll build</a>
                </li>
                <li class="nav-item">
                    <a href="#what-youll-need" class="nav-link">What you'll need</a>
                </li>
                <li class="nav-item">
                    <a href="#how-to-complete-this-guide" class="nav-link">How to complete this guide</a>
                </li>
                <li class="nav-item">
                    <a href="#update-dependencies" class="nav-link">Update dependencies</a>
                </li>
                <li class="nav-item">
                    <a href="#vault-testcontainer" class="nav-link">Vault TestContainer</a>
                </li>
                <li class="nav-item">
                    <a href="#configuration" class="nav-link">Configuration</a>
                </li>
                <li class="nav-item">
                    <a href="#update-file" class="nav-link">Update File</a>
                </li>
                <li class="nav-item">
                    <a href="#update-filecontentstore" class="nav-link">Update FileContentStore</a>
                </li>
                <li class="nav-item">
                    <a href="#build-an-executable-jar" class="nav-link">Build an executable JAR</a>
                </li>
                <li class="nav-item">
                    <a href="#test-encryption" class="nav-link">Test Encryption</a>
                </li>
                <li class="nav-item">
                    <a href="#summary" class="nav-link">Summary</a>
                </li>
        </ul>
    </div>
</div></div>
      </div>
      </div>

      <footer class="col-md-12">
	<hr>
	<div class="container">
	</div>
      </footer>
      <script>
	var base_url = "..",
            shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
      </script>
      <script src="../js/base.js" defer></script>
      <script src="../search/main.js" defer></script>

      <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <p class="h4 modal-title">Keyboard Shortcuts</p>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
